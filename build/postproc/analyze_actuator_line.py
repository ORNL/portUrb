from netCDF4 import Dataset
import numpy as np
import matplotlib.pyplot as plt
from cmap import Colormap

prefix = "fu2024_tsr_4_"
D = 126
R = 63
H = 90
R_hub = 1.5
V = 11.4
# V = 8
gen_eff = 0.944

t_end = 3

for i in range(1,t_end+1) :
  nc   = Dataset(f"{prefix}{i:08d}.nc","r")
  p    = np.array(nc["power0"][:])
  pwr  = p if i==1 else np.concatenate((pwr,p))
  t    = np.sum(np.array(nc["force_axial0"][:,:,:]),axis=(1,2))
  thr  = t if i==1 else np.concatenate((thr,t))
  tmp  = np.mean(np.array(nc["W0"][:,:,:]),axis=(1,2))
  W    = tmp if i==1 else np.concatenate((W,tmp))
  tmp  = np.mean(np.array(nc["inflow_axial0"][:,:,:]),axis=(1,2))
  Uax  = tmp if i==1 else np.concatenate((Uax,tmp))
  tmp  = np.mean(np.array(nc["inflow_tang0"][:,:,:]),axis=(1,2))
  Utan = tmp if i==1 else np.concatenate((Utan,tmp))
  if (i == t_end) :
    print( np.mean( np.array(nc["density_dry"][:,:,:])) )
    print( np.mean( p ) )
    print( "C_P: " , np.mean( p/gen_eff/(0.5*np.mean(np.array(nc["density_dry"][:,:,:]))*np.pi*R*R*V*V*V) ) )
    print( "C_T: " , np.mean( t        /(0.5*np.mean(np.array(nc["density_dry"][:,:,:]))*np.pi*R*R*V*V  ) ) )
plt.plot(pwr/1e6)
plt.title("power")
plt.grid()
plt.show()
plt.close()
# plt.plot(thr/1e6)
# plt.title("thrust")
# plt.grid()
# plt.show()
# plt.close()
# plt.plot(Uax)
# plt.title("axial flow")
# plt.grid()
# plt.show()
# plt.close()
# plt.plot(Utan)
# plt.title("tangential flow")
# plt.grid()
# plt.show()
# plt.close()

x    = np.array(nc["x"             ][:])
y    = np.array(nc["y"             ][:])
z    = np.array(nc["z"             ][:])
rad  = np.array(nc["radial_points" ][:])
dx   = x[1]-x[0]
dy   = y[1]-y[0]
dz   = z[1]-z[0]
xlen = x[-1]+dx/2
ylen = y[-1]+dy/2
zlen = z[-1]+dz/2

# plt.plot(np.array(nc["pitch0"][:])/np.pi*180)
# plt.ylabel("pitch angle (deg)")
# plt.show()
# plt.close()

fig,ax = plt.subplots(4,3,figsize=(12,12))
axlist = ax.flatten()
i = 0
for var in ["Cl","Cd","Cn","Ct","alpha","phi","W","U_rel_tang","force_axial","force_tang","inflow_axial","inflow_tang"] :
  mult = 180/np.pi  if (var=="alpha" or var=="phi")  else  1
  axlist[i].plot(rad/R,np.array(nc[f"{var}0"][-1,0,:])*mult,label="blade 0")
  axlist[i].plot(rad/R,np.array(nc[f"{var}0"][-1,1,:])*mult,label="blade 1")
  axlist[i].plot(rad/R,np.array(nc[f"{var}0"][-1,2,:])*mult,label="blade 2")
  axlist[i].grid(True)
  if var == "alpha" :
    axlist[i].set_ylim(0,10)
  axlist[i].set_title(f"{var} instantaneous")
  axlist[i].legend()
  i += 1
fig.tight_layout()
plt.show()
plt.close()

fig,ax = plt.subplots(4,3,figsize=(12,12))
axlist = ax.flatten()
i = 0
for var in ["Cl","Cd","Cn","Ct","alpha","phi","W","U_rel_tang","force_axial","force_tang","inflow_axial","inflow_tang"] :
  mult = 180/np.pi  if (var=="alpha" or var=="phi")  else  1
  axlist[i].plot(rad/R,np.mean(np.array(nc[f"{var}0"][:,0,:]),axis=(0))*mult,label="blade 0")
  axlist[i].plot(rad/R,np.mean(np.array(nc[f"{var}0"][:,1,:]),axis=(0))*mult,label="blade 1")
  axlist[i].plot(rad/R,np.mean(np.array(nc[f"{var}0"][:,2,:]),axis=(0))*mult,label="blade 2")
  axlist[i].grid(True)
  if var == "alpha" :
    axlist[i].set_ylim(0,10)
  axlist[i].set_title(f"{var} time_averaged")
  axlist[i].legend()
  i += 1
fig.tight_layout()
plt.show()
plt.close()

pub_r_2_1m = np.array([0.001358729,0.026064415,0.048684351,0.069491402,0.087476334,0.102971822,0.114540639,0.124251718,0.13309934,0.140231264,0.146974446,0.154298872,0.160836469,0.167852517,0.174489168,0.181333274,0.189564142,0.199121966,0.210799183,0.224373387,0.243541366,0.265000682,0.288013098,0.307317511,0.330868185,0.351880821,0.374816609,0.393950947,0.412294719,0.43381571,0.451935207,0.472017105,0.492758742,0.514077887,0.533808421,0.552142848,0.57235931,0.592385139,0.61062238,0.631577078,0.653933491,0.675041444,0.698044515,0.719552423,0.742467653,0.763543833,0.78526854,0.80627557,0.828312392,0.84839242,0.869483552,0.891111074,0.906262674,0.916448466,0.924462536,0.931921526,0.939130077,0.944594895,0.950474621,0.955453511,0.960161403,0.965777606,0.971590049,0.975098073,0.980478788,0.983115881])
pub_ax_2_1m = np.array([0.957137145,0.950640965,0.94755365,0.944232383,0.939213628,0.930186704,0.919808413,0.906800028,0.894668697,0.883151625,0.87128309,0.85894665,0.846664693,0.834034478,0.823248105,0.811047337,0.799664867,0.786943848,0.775731234,0.767155123,0.761080911,0.76007246,0.762606408,0.765664879,0.768128321,0.76772665,0.765202316,0.76057989,0.754816547,0.747033095,0.741488748,0.736107847,0.731158529,0.72563982,0.720663796,0.714740211,0.7078915,0.701837586,0.696406476,0.692360918,0.690141043,0.690115404,0.690961478,0.69208744,0.69170927,0.689566311,0.686294185,0.681872594,0.67704506,0.672955703,0.671480415,0.675974648,0.68567138,0.695774057,0.707134093,0.71866719,0.732175527,0.744056881,0.756780036,0.768485125,0.780636753,0.793199667,0.806180276,0.818449414,0.832037872,0.839664287])
pub_r_1_05m = np.array([0.001452176,0.028323979,0.053222168,0.077961496,0.097310764,0.112886616,0.124814273,0.134495448,0.143371105,0.152214989,0.16081591,0.169642974,0.178298094,0.187431666,0.198267855,0.212285,0.229707378,0.253629974,0.279288826,0.303540357,0.329294526,0.355871035,0.381023401,0.406192588,0.428868592,0.452122102,0.474867258,0.499328111,0.522316231,0.545980911,0.568976505,0.592319725,0.615999357,0.641267599,0.666668536,0.69223581,0.718591781,0.743605845,0.769419821,0.79490673,0.818937725,0.844050843,0.869092941,0.892880972,0.90939317,0.921543232,0.93120198,0.938898327,0.946045202,0.952848191,0.958516724,0.96484126,0.970597635,0.976000777,0.9827776])
pub_ax_1_05m = np.array([0.961069465,0.955206772,0.951453922,0.94667446,0.938242566,0.9257117,0.912590078,0.899785735,0.886076562,0.871415556,0.857291892,0.843009056,0.829554133,0.816178262,0.802300301,0.789650857,0.779401827,0.773960034,0.77488516,0.777642378,0.780029973,0.779599458,0.776496119,0.770678294,0.764116949,0.757351563,0.751252781,0.745713776,0.740136312,0.733924293,0.727345856,0.720259988,0.714198595,0.710162652,0.708357268,0.709164884,0.710454292,0.710280163,0.708085926,0.704277526,0.699805727,0.695051903,0.692830959,0.697610421,0.708539943,0.721644472,0.735277797,0.749411075,0.763518715,0.77791372,0.792392051,0.806837265,0.821436311,0.835219195,0.851024323])

nc = Dataset(f"{prefix}{t_end:08d}.nc","r")
inflow_axial = np.array(nc["inflow_axial0"][:,:,:])
plt.plot(rad/R,np.mean(inflow_axial,axis=(0,1))/V,label=f"portUrb 2.1m")
plt.plot(pub_r_2_1m,pub_ax_2_1m,label=f"openFOAM 2.1m")
plt.plot(pub_r_1_05m,pub_ax_1_05m,label=f"openFOAM 1.05m")
plt.xlabel("r/R")
plt.ylabel(r"$u_{axial}/u_{\infty}$")
plt.legend()
plt.grid()
plt.show()

nc = Dataset(f"{prefix}{t_end:08d}.nc","r")
inflow_axial = np.array(nc["force_axial0"][:,:,:])
plt.plot(rad/R,np.mean(inflow_axial,axis=(0,1)),label=f"portUrb")
plt.xlabel("r/R")
plt.ylabel(r"axial force (N)")
plt.legend()
plt.grid()
plt.show()

nc = Dataset(f"{prefix}{t_end:08d}.nc","r")
inflow_axial = np.array(nc["force_tang0"][:,:,:])
plt.plot(rad/R,np.mean(inflow_axial,axis=(0,1))*rad,label=f"portUrb")
plt.xlabel("r/R")
plt.ylabel(r"Torque (N m)")
plt.legend()
plt.grid()
plt.show()

pub_r_2_1m = [0.220988038,0.228094488,0.23685911,0.246635716,0.258821425,0.273525814,0.290811731,0.309828333,0.330396753,0.353791638,0.37758616,0.402938944,0.430868421,0.466139618,0.506517469,0.549568698,0.593320904,0.636541334,0.677716847,0.698510868,0.7196304,0.762541434,0.806586922,0.849710666,0.888712347,0.920077414,0.946774139,0.968451229,0.982227429]
pub_aoa_2_1m = [9.97590245,9.527456065,9.025439115,8.52373512,8.026872726,7.543467405,7.080164854,6.620838674,6.183051175,5.731825012,5.309445954,4.89945624,4.505795424,4.189139995,3.990634356,3.860150449,3.830088341,3.918268069,4.11439893,4.214931184,4.287297471,4.406772719,4.509293158,4.642575253,4.879353471,5.232827159,5.652076665,6.078892323,6.56174537]
pub_r_1_05m = [0.227524039,0.231768571,0.236348284,0.242043112,0.247623529,0.254826665,0.261409398,0.26960357,0.278300511,0.288307553,0.2982308,0.308677765,0.320296247,0.332162891,0.344670888,0.358274663,0.371839765,0.387240296,0.402241191,0.418565077,0.436558416,0.45597949,0.478837765,0.50269191,0.527056882,0.552720675,0.578067013,0.604206181,0.629552519,0.654748994,0.678314692,0.70197063,0.727727886,0.752871183,0.778427009,0.803721782,0.828890862,0.853515276,0.876942389,0.898590473,0.91711881,0.933051116,0.948720758,0.96228586,0.972039906,0.983859818]
pub_aoa_1_05m = [9.987076791,9.743524014,9.443547255,9.155518021,8.870029248,8.579864555,8.296548058,8.011409058,7.733560072,7.463166784,7.185060071,6.91578974,6.649777825,6.393080929,6.135040166,5.876612812,5.622990241,5.375682001,5.139750602,4.914017861,4.697158321,4.515092034,4.355632158,4.242876242,4.147038316,4.090246153,4.06051541,4.073880437,4.120253033,4.194644324,4.318427308,4.420745248,4.501285187,4.567042596,4.635064328,4.696826956,4.767646876,4.854795693,4.975651626,5.136713096,5.346264212,5.575789234,5.815052685,6.066226842,6.337356495,6.736079822]

nc = Dataset(f"{prefix}{t_end:08d}.nc","r")
inflow_axial = np.array(nc["alpha0"][:,:,:])
plt.plot(rad/R,np.mean(inflow_axial,axis=(0,1))/np.pi*180,label=f"portUrb 2.1m")
plt.plot(pub_r_2_1m,pub_aoa_2_1m,label=f"openFOAM 2.1m")
plt.plot(pub_r_1_05m,pub_aoa_1_05m,label=f"openFOAM 1.05m")
plt.ylim(2,10)
plt.xlabel("r/R")
plt.ylabel(r"Angle of Attack (deg)")
plt.legend()
plt.grid()
plt.show()

nc = Dataset(f"{prefix}{t_end:08d}.nc","r")
inflow_axial = np.array(nc["inflow_axial0"][:,:,:])
plt.plot(rad/R,1-np.mean(inflow_axial,axis=(0,1))/V,label=f"portUrb")
plt.xlabel("r/R")
plt.ylabel(r"Axial induction factor")
plt.legend()
plt.grid()
plt.show()

k = np.argmin(np.abs(z-H))
i = np.argmin(np.abs(x-5*D))

pub_y_2_1m = np.array([-1.4958051,-1.361006976,-1.204708111,-1.016950002,-0.811660519,-0.729306163,-0.687873381,-0.657632012,-0.642631611,-0.628237641,-0.623050399,-0.611984283,-0.602757508,-0.592964396,-0.586940179,-0.579793312,-0.573678882,-0.566366625,-0.557300229,-0.548223808,-0.530933002,-0.506695802,-0.470710878,-0.415455475,-0.389053165,-0.348026342,-0.306904294,-0.261502145,-0.240241971,-0.209990578,-0.172692554,-0.149743394,-0.134592639,-0.11959725,-0.108841867,-0.098171685,-0.079542721,-0.067825067,-0.048795157,-0.024061786,0.001022413,0.029700092,0.041543042,0.060938816,0.07287699,0.085396536,0.097926106,0.107513732,0.119196303,0.133374764,0.137449381,0.147528166,0.157150876,0.182986849,0.223547572,0.241359609,0.284922417,0.322836895,0.36392386,0.389233591,0.43383886,0.459113508,0.483390802,0.515316146,0.542124414,0.552198188,0.561560282,0.570446253,0.576645884,0.583236438,0.590603825,0.595560523,0.603208572,0.61224991,0.620138527,0.636958221,0.654504631,0.675920172,0.701836334,0.798023335,0.926536626,1.116996111,1.321734293,1.463278337,1.500015035])
pub_def_2_1m = np.array([1.012076092,1.012370113,1.014982889,1.016810495,1.021132266,1.022817874,1.023031707,1.014874301,0.985859796,0.959628465,0.910765886,0.869075076,0.823181104,0.760798581,0.714774306,0.670652812,0.626980702,0.583315275,0.538323413,0.493488585,0.451425237,0.439138175,0.451289921,0.441391778,0.444116482,0.481782883,0.525237818,0.568251722,0.591317318,0.606020028,0.615993346,0.637436817,0.682168069,0.730613005,0.775785288,0.817043421,0.884758411,0.928455579,0.967189476,0.98616217,0.983419089,0.988652993,0.975483869,0.956633128,0.913483908,0.867877275,0.822870378,0.781847797,0.735075104,0.688193825,0.656040313,0.648973791,0.630351918,0.608921812,0.605742713,0.590323327,0.549006725,0.509424177,0.464156671,0.443919354,0.442932046,0.447327322,0.450962488,0.438956083,0.465959219,0.508844489,0.554442769,0.596011627,0.640938337,0.685936881,0.729792754,0.7745641,0.820914137,0.862830475,0.90724766,0.969529949,1.006180641,1.019413247,1.021792143,1.019957854,1.018150294,1.015430602,1.013063401,1.012002587,1.012233126])

nc = Dataset(f"{prefix}{t_end:08d}.nc","r")
u = np.array(nc["avg_u"][k,:,i])
plt.plot((y-ylen/2)/D,u/V,label=f"portUrb 2.1m")
plt.plot(pub_y_2_1m,pub_def_2_1m,label=f"openFOAM 2.1m")
plt.title("1 turbine diameter downstream")
plt.xlabel("y/D")
plt.ylabel(r"$u/u_{\infty}$")
plt.xlim(-1.5,1.5)
plt.ylim(0.4,1.1)
plt.legend()
plt.grid()
plt.show()

i = np.argmin(np.abs(x-8*D))

pub_y_2_1m = np.array([-1.498164956,-1.142991518,-0.859411202,-0.762081257,-0.710911251,-0.67075151,-0.654374732,-0.635846068,-0.616307469,-0.603660187,-0.589131655,-0.573857223,-0.557236212,-0.540344566,-0.521848906,-0.511624146,-0.483108353,-0.449879534,-0.414802469,-0.391600383,-0.362008647,-0.319743226,-0.275603155,-0.246829928,-0.223667448,-0.179804614,-0.166576455,-0.147757352,-0.134403776,-0.113089541,-0.088164626,-0.061213241,-0.032129773,-0.002775669,0.038453414,0.064619294,0.092296775,0.116997261,0.135743754,0.148767286,0.156265883,0.180062048,0.217904881,0.248598964,0.294244034,0.333473052,0.393039374,0.438050761,0.482850919,0.510317172,0.534152942,0.548542856,0.567758012,0.582444965,0.597851414,0.614551635,0.63105383,0.640717515,0.659959075,0.67774184,0.697610482,0.752787221,0.891484867,1.227337536,1.497287039])
pub_def_2_1m = np.array([1.007725303,1.008424804,1.008860342,1.009071512,1.00175975,0.976678912,0.954547854,0.909498251,0.846470601,0.798911155,0.735166406,0.666610941,0.600651108,0.535126812,0.494355602,0.46936495,0.448973846,0.430654847,0.426950573,0.429561602,0.449902114,0.490178395,0.532762148,0.557064297,0.570477992,0.589186336,0.615888344,0.656012846,0.703077363,0.771151097,0.835450166,0.898644992,0.947385671,0.960027276,0.94218561,0.900006599,0.833314269,0.768298102,0.702696817,0.655990849,0.638809089,0.588515431,0.575693452,0.555665296,0.512925365,0.471377664,0.42929324,0.433919183,0.453753767,0.471804404,0.518703944,0.564732408,0.629280042,0.694604166,0.761987198,0.831308154,0.893004993,0.917656893,0.961958602,0.982248521,0.997919095,1.008985724,1.008649172,1.00823783,1.007258969])

nc = Dataset(f"{prefix}{t_end:08d}.nc","r")
u = np.array(nc["avg_u"][k,:,i])
plt.plot((y-ylen/2)/D,u/V,label=f"portUrb 2.1m")
plt.plot(pub_y_2_1m,pub_def_2_1m,label=f"openFOAM 2.1m")
plt.title("4 turbine diameter downstream")
plt.xlabel("y/D")
plt.ylabel(r"$u/u_{\infty}$")
plt.xlim(-1.5,1.5)
plt.ylim(0.3,1.1)
plt.legend()
plt.grid()
plt.show()


i = np.argmin(np.abs(x-6*D))
k = np.argmin(np.abs(z-H))
i1 = np.argmin(np.abs(x-3.25*D))
i2 = np.argmin(np.abs(x-9*D))
j1 = np.argmin(np.abs(y-0.75*D))
j2 = np.argmin(np.abs(y-3.25*D))

X,Y = np.meshgrid(x[i1:i2],y[j1:j2])
plt.contourf(X,Y,np.array(nc["avg_u"][k,j1:j2,i1:i2]),levels=np.arange(3,8,0.01),cmap="jet",extend="both")
plt.xlabel("x-location")
plt.ylabel("y-location")
# plt.gca().invert_xaxis()
plt.gca().set_aspect("equal")
plt.colorbar(orientation="horizontal")
plt.tight_layout()
plt.show()
plt.close()

u = np.array(nc["uvel"][k,j1:j2,i1:i2])
v = np.array(nc["vvel"][k,j1:j2,i1:i2])
vort = np.gradient(v,dx,axis=1) - np.gradient(u,dy,axis=0)

X,Y = np.meshgrid(x[i1:i2],y[j1:j2])
plt.contourf(X,Y,np.abs(vort),levels=np.arange(0,0.35,0.35/100),cmap="jet",extend="both")
plt.xlabel("x-location")
plt.ylabel("y-location")
# plt.gca().invert_xaxis()
plt.gca().set_aspect("equal")
plt.colorbar(orientation="horizontal")
plt.tight_layout()
plt.show()
plt.close()



i  = np.argmin(np.abs(x-4.00*D))
j1 = np.argmin(np.abs(y-1.25*D))
j2 = np.argmin(np.abs(y-2.75*D))
k2 = np.argmin(np.abs(z-1.50*D))
Y,Z = np.meshgrid(y[j1:j2],z[:k2])

plt.contourf(Y,Z,np.array(nc["turbine_tend_u"][:k2,j1:j2,i-4]),levels=100,cmap=Colormap('cmasher:fusion_r').to_mpl(),extend="both")
plt.gca().set_aspect("equal")
plt.colorbar(orientation="horizontal")
plt.gca().invert_xaxis()
plt.tight_layout()
plt.show()
plt.close()

plt.contourf(Y,Z,np.array(nc["turbine_tend_v"][:k2,j1:j2,i-4]),levels=100,cmap=Colormap('cmasher:fusion_r').to_mpl(),extend="both")
plt.gca().set_aspect("equal")
plt.colorbar(orientation="horizontal")
plt.gca().invert_xaxis()
plt.tight_layout()
plt.show()
plt.close()

plt.contourf(Y,Z,np.array(nc["turbine_tend_w"][:k2,j1:j2,i-4]),levels=100,cmap=Colormap('cmasher:fusion_r').to_mpl(),extend="both")
plt.gca().set_aspect("equal")
plt.colorbar(orientation="horizontal")
plt.gca().invert_xaxis()
plt.tight_layout()
plt.show()
plt.close()
